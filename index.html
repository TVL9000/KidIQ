<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>IQ Trainer</title>

<style>
body {
  margin:0;
  font-family:-apple-system,system-ui;
  background:#0b1220;
  color:#eaf2ff;
}
.wrap { padding:16px; display:grid; gap:12px }
.card {
  background:rgba(255,255,255,.08);
  border-radius:16px;
  padding:14px;
}
.row { display:flex; gap:8px; flex-wrap:wrap }
.pill {
  background:rgba(255,255,255,.15);
  padding:6px 10px;
  border-radius:999px;
  font-size:12px;
}
button {
  width:100%;
  padding:12px;
  border-radius:14px;
  border:0;
  font-weight:700;
}
.primary { background:#4aa3ff; color:#06101f }
.secondary { background:rgba(255,255,255,.15); color:#fff }
.hidden { display:none }
.grid2 { display:grid; grid-template-columns:repeat(2,1fr); gap:8px }
.grid3 { display:grid; grid-template-columns:repeat(3,1fr); gap:8px }
.big { font-size:32px; text-align:center; font-weight:900 }
.center { text-align:center }
.barOuter {
  height:8px;
  background:rgba(255,255,255,.15);
  border-radius:999px;
}
.barInner {
  height:100%;
  background:#78ff9c;
  border-radius:999px;
}
</style>
</head>

<body>
<div class="wrap">

<!-- HOME -->
<div class="card" id="homeCard">
  <h2>ğŸ§  IQ Trainer</h2>
  <button class="primary" id="startBtn">Start Session</button>
</div>

<!-- GAME -->
<div class="card hidden" id="gameCard">
  <div class="row">
    <div class="pill" id="gameName"></div>
    <div class="pill" id="roundPill"></div>
    <div class="pill" id="difficultyPill"></div>
  </div>
  <div style="height:10px"></div>
  <div id="gameArea"></div>
</div>

<!-- SUMMARY -->
<div class="wrap hidden" id="summaryView"></div>

</div>

<script>
/* ---------------- STORAGE ---------------- */
const store = {
  get:(k,d)=>JSON.parse(localStorage.getItem(k)) ?? d,
  set:(k,v)=>localStorage.setItem(k,JSON.stringify(v))
};
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const getDiff = g => store.get("diff_"+g,1);
const setDiff = (g,l) => store.set("diff_"+g,l);

/* ---------------- GAME META ---------------- */
const games = ["pattern","math","memory","color","odd","speed"];
const meta = {
  pattern:{icon:"ğŸ§©",name:"Pattern Match"},
  math:{icon:"ğŸ”¢",name:"Quick Math"},
  memory:{icon:"ğŸ§ ",name:"Memory Flash"},
  color:{icon:"ğŸŸ¦",name:"Color Grid Memory"},
  odd:{icon:"â“",name:"Odd One Out"},
  speed:{icon:"âš¡",name:"Speed Tap"}
};

/* ---------------- SESSION ENGINE ---------------- */
const Engine = {
  cycles:3,
  cycle:1,
  gi:0,
  ri:0,
  block:[],
  results:{},
  difficulty:{},

  start(){
    this.cycle=1; this.gi=0; this.ri=0; this.block=[];
    this.results={}; this.difficulty={};

    games.forEach(g=>{
      const d = getDiff(g);
      this.difficulty[g] = d;
      this.results[g] = { start:d, scores:[], end:d };
    });

    homeCard.classList.add("hidden");
    summaryView.classList.add("hidden");
    gameCard.classList.remove("hidden");
    this.startRound();
  },

  startRound(){
    const g = games[this.gi];
    gameName.textContent = meta[g].icon+" "+meta[g].name;
    roundPill.textContent = `Round ${this.ri+1}/3 â€¢ Cycle ${this.cycle}/3`;
    difficultyPill.textContent = `Level ${this.difficulty[g]}`;
    Game.render(g,this.difficulty[g]);
  },

  record(score){
    this.block.push(score);
    this.ri++;
    this.ri===3 ? this.finishBlock() : this.startRound();
  },

  finishBlock(){
    const g = games[this.gi];
    const avg = this.block.reduce((a,b)=>a+b,0)/3;
    this.results[g].scores.push(Math.round(avg));

    let d = this.difficulty[g];
    if(avg>=80) d++;
    else if(avg<=40) d--;
    d = clamp(d,1,4);

    this.difficulty[g] = d;
    setDiff(g,d);
    this.results[g].end = d;

    this.block=[]; this.ri=0; this.gi++;
    this.gi===games.length ? this.finishCycle() : this.startRound();
  },

  finishCycle(){
    this.gi=0;
    this.cycle<this.cycles ? (this.cycle++,this.startRound()) : this.finishSession();
  },

  finishSession(){
    gameCard.classList.add("hidden");
    renderSummary(this.results);
  }
};

/* ---------------- GAME ROUTER ---------------- */
const Game = {
  render(type,level){
    ({
      pattern, math, memory, color, odd, speed
    })[type](level);
  }
};

/* ---------------- GAMES ---------------- */

/* Pattern Match â€“ starts at 4 items */
function pattern(level){
  const shapes=["â–²","â– ","â—","â—†","â˜…"];
  const size = level>=3 ? 3 : 2;
  const total=size*size;
  const a=shapes[Math.floor(Math.random()*shapes.length)];
  let b=shapes[Math.floor(Math.random()*shapes.length)];
  while(b===a) b=shapes[Math.floor(Math.random()*shapes.length)];

  let grid=[];
  for(let i=0;i<total;i++) grid.push(i%2===0?a:b);
  const answer=grid[total-1];
  grid[total-1]="â“";

  const choices=[answer];
  while(choices.length<4){
    const s=shapes[Math.floor(Math.random()*shapes.length)];
    if(!choices.includes(s)) choices.push(s);
  }
  choices.sort(()=>Math.random()-.5);

  gameArea.innerHTML=`
    <div class="grid${size}">
      ${grid.map(x=>`<div class="card center big">${x}</div>`).join("")}
    </div>
    <div style="height:12px"></div>
    <div class="grid2">
      ${choices.map(c=>`<button class="secondary big">${c}</button>`).join("")}
    </div>
  `;
  [...gameArea.querySelectorAll("button")].forEach(b=>{
    b.onclick=()=>Engine.record(b.textContent===answer?100:0);
  });
}

/* Quick Math */
function math(){
  const a=Math.floor(Math.random()*20)+5;
  const b=Math.floor(Math.random()*20)+5;
  const ans=a+b;
  const opts=[ans,ans+1,ans-1].sort(()=>Math.random()-.5);
  gameArea.innerHTML=`
    <div class="big">${a}+${b}</div>
    <div class="grid3">
      ${opts.map(o=>`<button class="secondary">${o}</button>`).join("")}
    </div>
  `;
  [...gameArea.querySelectorAll("button")].forEach(b=>{
    b.onclick=()=>Engine.record(+b.textContent===ans?100:0);
  });
}

/* Memory Flash */
function memory(level){
  const emojis=["ğŸ¶","ğŸ±","ğŸ¦Š","ğŸ¼","ğŸ¦","ğŸ¸"];
  const len=level+1;
  const seq=[...Array(len)].map(()=>emojis[Math.floor(Math.random()*emojis.length)]);
  gameArea.innerHTML=`<div class="big">${seq.join(" ")}</div><button class="primary">Ready</button>`;
  gameArea.querySelector("button").onclick=()=>{
    const ans=seq[Math.floor(Math.random()*seq.length)];
    const opts=[ans,...emojis.filter(e=>e!==ans)].slice(0,4).sort(()=>Math.random()-.5);
    gameArea.innerHTML=`<div class="grid2">${opts.map(o=>`<button class="secondary big">${o}</button>`).join("")}</div>`;
    [...gameArea.querySelectorAll("button")].forEach(b=>{
      b.onclick=()=>Engine.record(b.textContent===ans?100:0);
    });
  };
}

/* Color Grid â€“ FIXED RANDOMNESS */
function color(level){
  const size = level + 2;          // Level 1 = 3x3
  const tiles = level + 2;         // number of targets
  const total = size * size;

  /* ---- DISPERSION CONTROL ----
     Lower levels = clustered
     Higher levels = spread out
  */
  const dispersionRadius = level === 1 ? 1 : level === 2 ? 2 : size;

  const positions = [...Array(total).keys()];

  // Pick first target
  const first = positions[Math.floor(Math.random() * positions.length)];
  const targets = [first];

  // Pick remaining targets based on dispersion
  while (targets.length < tiles) {
    const candidate = positions[Math.floor(Math.random() * positions.length)];
    const ok = targets.every(t => {
      const dx = Math.abs((t % size) - (candidate % size));
      const dy = Math.abs(Math.floor(t / size) - Math.floor(candidate / size));
      return dx + dy >= dispersionRadius;
    });
    if (ok && !targets.includes(candidate)) targets.push(candidate);
  }

  // Render grid ONCE
  gameArea.innerHTML = `
    <div class="grid${size}">
      ${positions.map(i=>`
        <button
          class="secondary color-tile blank"
          data-index="${i}"
          style="height:42px">
        </button>
      `).join("")}
    </div>
  `;

  const tilesEls = [...gameArea.querySelectorAll(".color-tile")];

  /* ---- SHOW PHASE ---- */
  tilesEls.forEach(btn=>{
    if (targets.includes(+btn.dataset.index)) {
      btn.classList.add("reveal");
    }
  });

  /* ---- FLIP PHASE ---- */
  setTimeout(()=>{
    tilesEls.forEach(btn=>{
      btn.classList.remove("reveal");
      btn.classList.add("blank");
    });

    let chosen = [];

    tilesEls.forEach(btn=>{
      btn.onclick = ()=>{
        const idx = +btn.dataset.index;
        if (chosen.includes(idx)) return;

        chosen.push(idx);
        btn.classList.remove("blank");

        if (targets.includes(idx)) {
          btn.classList.add("correct");
        } else {
          btn.classList.add("wrong");
        }

        /* ---- SCORING (PARTIAL CREDIT) ---- */
        if (chosen.length === tiles) {
          const correctCount = chosen.filter(i => targets.includes(i)).length;
          const score = Math.round((correctCount / tiles) * 100);

          // brief feedback delay
          setTimeout(() => Engine.record(score), 400);
        }
      };
    });
  },

/* Odd One Out */
function odd(){
  const packs=[
    ["ğŸ","ğŸŒ","ğŸ“","ğŸš—"],
    ["ğŸ¶","ğŸ±","ğŸ­","ğŸ•"],
    ["âš½","ğŸ€","ğŸ¾","ğŸ§"]
  ];
  const pack=packs[Math.floor(Math.random()*packs.length)];
  const odd=pack.find(x=>!["ğŸ","ğŸŒ","ğŸ“","ğŸ¶","ğŸ±","ğŸ­","âš½","ğŸ€","ğŸ¾"].includes(x));
  gameArea.innerHTML=`<div class="grid2">${pack.sort(()=>Math.random()-.5).map(o=>`<button class="secondary big">${o}</button>`).join("")}</div>`;
  [...gameArea.querySelectorAll("button")].forEach(b=>{
    b.onclick=()=>Engine.record(b.textContent===odd?100:0);
  });
}

/* Speed Tap */
function speed(){
  const syms=["ğŸŸ¥","ğŸŸ¦","ğŸŸ©","ğŸŸ¨"];
  const t=syms[Math.floor(Math.random()*syms.length)];
  gameArea.innerHTML=`<div class="big">Tap ${t}</div><div class="grid2">${syms.sort(()=>Math.random()-.5).map(o=>`<button class="secondary big">${o}</button>`).join("")}</div>`;
  [...gameArea.querySelectorAll("button")].forEach(b=>{
    b.onclick=()=>Engine.record(b.textContent===t?100:0);
  });
}

/* ---------------- SUMMARY ---------------- */
function renderSummary(r){
  summaryView.innerHTML="";
  summaryView.classList.remove("hidden");
  summaryView.innerHTML+=`<div class="card"><h2>â­ Session Complete</h2></div>`;
  Object.keys(r).forEach(g=>{
    summaryView.innerHTML+=`
      <div class="card">
        <div class="row">
          <div class="pill">${meta[g].icon} ${meta[g].name}</div>
          <div class="pill">${r[g].start} â†’ ${r[g].end}</div>
        </div>
        <div class="grid3">
          ${r[g].scores.map(s=>`<div class="barOuter"><div class="barInner" style="width:${s}%"></div></div>`).join("")}
        </div>
      </div>`;
  });
  summaryView.innerHTML+=`<div class="card"><button class="primary" onclick="location.reload()">New Session</button></div>`;
}

/* ---------------- START ---------------- */
startBtn.onclick=()=>Engine.start();
</script>
</body>
</html>
